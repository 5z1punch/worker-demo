<!DOCTYPE html>
<html>
<head>
  <title>Secret Handler</title>
  <style>
    .storage-access-prompt {
      padding: 20px;
      text-align: center;
      background: #f0f0f0;
      border: 1px solid #ccc;
      margin: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="storageAccessPrompt" class="storage-access-prompt hidden">
    <h2>Storage Access Required</h2>
    <p>This page needs access to storage to retrieve the secret.</p>
    <button id="requestAccessBtn">Allow Storage Access</button>
  </div>

  <script>
    const DB_NAME = 'SecretDB';
    const STORE_NAME = 'secrets';
    const ALLOWED_PARENT_ORIGIN = 'http://localhost:5174';
    const OWN_ORIGIN = 'http://localhost:5173';

    // Request storage access for Safari
    async function requestStorageAccess() {
      try {
        // Check if the requestStorageAccess API is available
        if (document.hasStorageAccess && document.requestStorageAccess) {
          const hasAccess = await document.hasStorageAccess();
          if (!hasAccess) {
            // Show the prompt
            document.getElementById('storageAccessPrompt').classList.remove('hidden');
            return false;
          } else {
            console.log('Already has storage access');
            return true;
          }
        }
        return true;
      } catch (e) {
        console.error('Failed to get storage access:', e);
        return false;
      }
    }

    // Handle the button click
    document.getElementById('requestAccessBtn')?.addEventListener('click', async () => {
      try {
        await document.requestStorageAccess();
        console.log('Storage access granted');
        document.getElementById('storageAccessPrompt').classList.add('hidden');
        // Reinitialize after getting access
        initialize();
      } catch (error) {
        console.error('Failed to get storage access:', error);
        window.parent.postMessage({
          type: 'ERROR',
          error: 'Failed to get storage access'
        }, ALLOWED_PARENT_ORIGIN);
      }
    });

    async function initDB() {
      const hasAccess = await requestStorageAccess();
      if (!hasAccess) {
        throw new Error('No storage access');
      }

      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME);

        request.onerror = () => {
          console.error('DB: Database error:', request.error);
          reject(request.error);
        };

        request.onsuccess = () => {
          console.log('DB: Database opened successfully');
          resolve(request.result);
        };

        request.onupgradeneeded = (event) => {
          console.log('DB: Upgrading database...');
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            console.log('DB: Creating object store:', STORE_NAME);
            db.createObjectStore(STORE_NAME);
          }
        };
      });
    }

    async function getSecret() {
      try {
        const db = await initDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(STORE_NAME, 'readonly');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.get('secretKey');

          request.onsuccess = () => {
            console.log('DB: Secret retrieved:', request.result);
            resolve(request.result);
            db.close();
          };

          request.onerror = () => {
            console.error('DB: Error getting secret:', request.error);
            reject(request.error);
            db.close();
          };
        });
      } catch (error) {
        if (error.message === 'No storage access') {
          window.parent.postMessage({
            type: 'STORAGE_ACCESS_REQUIRED',
            error: 'Storage access required'
          }, ALLOWED_PARENT_ORIGIN);
        }
        throw error;
      }
    }

    // Check if we're embedded in the correct parent
    function checkParentOrigin() {
      try {
        // First check if we're in an iframe
        if (window.parent === window) {
          console.log('Not in iframe');
          return false;
        }

        // Try to access parent location (will throw if cross-origin)
        const parentUrl = document.referrer;
        console.log('Parent URL:', parentUrl);
        const isAllowed = parentUrl.startsWith(ALLOWED_PARENT_ORIGIN);
        console.log('Is allowed parent:', isAllowed);
        return isAllowed;
      } catch (e) {
        console.error('Could not access parent origin:', e);
        return false;
      }
    }

    // Listen for messages from parent window
    window.addEventListener('message', async (event) => {
      console.log('Secret handler: Received message from:', event.origin);
      
      // Verify sender origin first
      if (event.origin !== ALLOWED_PARENT_ORIGIN && event.origin !== OWN_ORIGIN) {
        console.error('Message from unauthorized origin:', event.origin);
        return;
      }

      // Additional source check for extra security
      if (event.source !== window.parent && event.source !== window) {
        console.error('Message from unauthorized source');
        return;
      }

      console.log('Secret handler: Received message:', event.data);
      if (event.data.type === 'GET_SECRET') {
        try {
          const secret = await getSecret();
          // Always send back to the parent origin
          window.parent.postMessage({
            type: 'SECRET_VALUE',
            secret: secret
          }, ALLOWED_PARENT_ORIGIN);
        } catch (error) {
          window.parent.postMessage({
            type: 'ERROR',
            error: error.message
          }, ALLOWED_PARENT_ORIGIN);
        }
      }
    });

    // Modified initialize function
    async function initialize() {
      if (checkParentOrigin()) {
        const hasAccess = await requestStorageAccess();
        if (hasAccess) {
          console.log('Sending READY signal to parent');
          window.parent.postMessage({ type: 'READY' }, ALLOWED_PARENT_ORIGIN);
        }
      } else {
        console.error('Not embedded in allowed parent');
        document.body.innerHTML = '<h1>Access Denied</h1><p>This page can only be accessed from the authorized application.</p>';
      }
    }

    // Start initialization
    initialize();
  </script>
</body>
</html> 