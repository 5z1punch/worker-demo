<!DOCTYPE html>
<html>
<head>
  <title>Secret Handler</title>
  <style>
    .storage-access-prompt {
      padding: 20px;
      text-align: center;
      background: #f0f0f0;
      border: 1px solid #ccc;
      margin: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="storageAccessPrompt" class="storage-access-prompt hidden">
    <h2>Storage Access Required</h2>
    <p>This page needs access to storage to retrieve the secret.</p>
    <button id="requestAccessBtn">Allow Storage Access</button>
  </div>
  <div id="status"></div>

  <script>
    const DB_NAME = 'SecretDB';
    const STORE_NAME = 'secrets';
    const ALLOWED_PARENT_ORIGIN = 'http://localhost:5174';
    const OWN_ORIGIN = 'http://localhost:5173';

    function updateStatus(message) {
      console.log(message);
      const status = document.getElementById('status');
      if (status) {
        status.textContent = message;
      }
    }

    async function requestStorageAccess() {
      try {
        if (document.hasStorageAccess && document.requestStorageAccess) {
          const hasAccess = await document.hasStorageAccess();
          updateStatus(`Has storage access: ${hasAccess}`);
          if (!hasAccess) {
            document.getElementById('storageAccessPrompt').classList.remove('hidden');
            return false;
          }
        }
        return true;
      } catch (e) {
        updateStatus(`Storage access error: ${e.message}`);
        return false;
      }
    }

    async function initDB() {
      updateStatus('Initializing DB...');
      const hasAccess = await requestStorageAccess();
      if (!hasAccess) {
        updateStatus('No storage access');
        throw new Error('No storage access');
      }

      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME);

        request.onerror = () => {
          updateStatus(`DB error: ${request.error}`);
          reject(request.error);
        };

        request.onsuccess = () => {
          updateStatus('DB opened successfully');
          resolve(request.result);
        };

        request.onupgradeneeded = (event) => {
          updateStatus('Upgrading database...');
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            updateStatus('Creating object store');
            db.createObjectStore(STORE_NAME);
          }
        };
      });
    }

    async function getSecret() {
      updateStatus('Getting secret...');
      try {
        const db = await initDB();
        return new Promise((resolve, reject) => {
          try {
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('secretKey');

            request.onsuccess = () => {
              updateStatus(`Secret retrieved: ${request.result}`);
              resolve(request.result);
              db.close();
            };

            request.onerror = () => {
              updateStatus(`Error getting secret: ${request.error}`);
              reject(request.error);
              db.close();
            };

            transaction.onerror = (event) => {
              updateStatus(`Transaction error: ${event}`);
              reject(new Error('Transaction failed'));
            };
          } catch (error) {
            updateStatus(`Transaction creation error: ${error}`);
            reject(error);
          }
        });
      } catch (error) {
        updateStatus(`GetSecret error: ${error.message}`);
        if (error.message === 'No storage access') {
          window.parent.postMessage({
            type: 'STORAGE_ACCESS_REQUIRED',
            error: 'Storage access required'
          }, ALLOWED_PARENT_ORIGIN);
        }
        throw error;
      }
    }

    // Check if we're embedded in the correct parent
    function checkParentOrigin() {
      try {
        // First check if we're in an iframe
        if (window.parent === window) {
          console.log('Not in iframe');
          return false;
        }

        // Try to access parent location (will throw if cross-origin)
        const parentUrl = document.referrer;
        console.log('Parent URL:', parentUrl);
        const isAllowed = parentUrl.startsWith(ALLOWED_PARENT_ORIGIN);
        console.log('Is allowed parent:', isAllowed);
        return isAllowed;
      } catch (e) {
        console.error('Could not access parent origin:', e);
        return false;
      }
    }

    // Modified message handler
    window.addEventListener('message', async (event) => {
      updateStatus(`Received message from: ${event.origin}`);
      
      if (event.origin !== ALLOWED_PARENT_ORIGIN && event.origin !== OWN_ORIGIN) {
        updateStatus(`Unauthorized origin: ${event.origin}`);
        return;
      }

      if (event.source !== window.parent && event.source !== window) {
        updateStatus('Unauthorized source');
        return;
      }

      updateStatus(`Processing message: ${JSON.stringify(event.data)}`);
      if (event.data.type === 'GET_SECRET') {
        try {
          const secret = await getSecret();
          updateStatus(`Sending secret back: ${secret}`);
          window.parent.postMessage({
            type: 'SECRET_VALUE',
            secret: secret
          }, ALLOWED_PARENT_ORIGIN);
        } catch (error) {
          updateStatus(`Error handling message: ${error.message}`);
          window.parent.postMessage({
            type: 'ERROR',
            error: error.message
          }, ALLOWED_PARENT_ORIGIN);
        }
      }
    });

    // Modified initialize function
    async function initialize() {
      if (checkParentOrigin()) {
        const hasAccess = await requestStorageAccess();
        if (hasAccess) {
          console.log('Sending READY signal to parent');
          window.parent.postMessage({ type: 'READY' }, ALLOWED_PARENT_ORIGIN);
        }
      } else {
        console.error('Not embedded in allowed parent');
        document.body.innerHTML = '<h1>Access Denied</h1><p>This page can only be accessed from the authorized application.</p>';
      }
    }

    // Handle the button click
    document.getElementById('requestAccessBtn')?.addEventListener('click', async () => {
      try {
        await document.requestStorageAccess();
        console.log('Storage access granted');
        document.getElementById('storageAccessPrompt').classList.add('hidden');
        // Reinitialize after getting access
        initialize();
      } catch (error) {
        console.error('Failed to get storage access:', error);
        window.parent.postMessage({
          type: 'ERROR',
          error: 'Failed to get storage access'
        }, ALLOWED_PARENT_ORIGIN);
      }
    });

    // Start initialization
    initialize();
  </script>
</body>
</html> 