<!DOCTYPE html>
<html>
<head>
  <title>Secret Handler</title>
  <style>
    .storage-access-prompt {
      padding: 20px;
      text-align: center;
      background: #f0f0f0;
      border: 1px solid #ccc;
      margin: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="storageAccessPrompt" class="storage-access-prompt hidden">
    <h2>Storage Access Required</h2>
    <p>This page needs access to storage to retrieve the secret.</p>
    <button id="requestAccessBtn">Allow Storage Access</button>
  </div>
  <div id="status"></div>

  <script>
    const STORAGE_KEY = 'secretKey';
    const ALLOWED_PARENT_ORIGIN = 'http://localhost:5174';
    const OWN_ORIGIN = 'http://localhost:5173';

    function updateStatus(message) {
      console.log(message);
      const status = document.getElementById('status');
      if (status) {
        status.textContent = message;
      }
    }

    // Test localStorage access
    function testLocalStorage() {
      try {
        localStorage.setItem('test', 'test');
        const value = localStorage.getItem('test');
        localStorage.removeItem('test');
        return value === 'test';
      } catch (e) {
        return false;
      }
    }

    async function requestStorageAccess() {
      try {
        // First test localStorage
        if (!testLocalStorage()) {
          updateStatus('localStorage not accessible');
          if (document.hasStorageAccess && document.requestStorageAccess) {
            const hasAccess = await document.hasStorageAccess();
            updateStatus(`Has storage access: ${hasAccess}`);
            if (!hasAccess) {
              document.getElementById('storageAccessPrompt').classList.remove('hidden');
              return false;
            }
          }
        } else {
          updateStatus('localStorage is accessible');
          return true;
        }
        return true;
      } catch (e) {
        updateStatus(`Storage access error: ${e.message}`);
        return false;
      }
    }

    async function getSecret() {
      updateStatus('Getting secret...');
      try {
        const hasAccess = await requestStorageAccess();
        if (!hasAccess) {
          updateStatus('No storage access');
          throw new Error('No storage access');
        }

        // Try to access localStorage
        try {
          const secret = localStorage.getItem(STORAGE_KEY);
          updateStatus(`Raw localStorage value: ${localStorage.getItem(STORAGE_KEY)}`);
          updateStatus(`Secret retrieved: ${secret}`);
          return secret;
        } catch (e) {
          updateStatus(`localStorage access error: ${e.message}`);
          throw e;
        }
      } catch (error) {
        updateStatus(`GetSecret error: ${error.message}`);
        if (error.message === 'No storage access') {
          window.parent.postMessage({
            type: 'STORAGE_ACCESS_REQUIRED',
            error: 'Storage access required'
          }, ALLOWED_PARENT_ORIGIN);
        }
        throw error;
      }
    }

    // Check if we're embedded in the correct parent
    function checkParentOrigin() {
      try {
        if (window.parent === window) {
          updateStatus('Not in iframe');
          return false;
        }

        const parentUrl = document.referrer;
        updateStatus(`Parent URL: ${parentUrl}`);
        const isAllowed = parentUrl.startsWith(ALLOWED_PARENT_ORIGIN);
        updateStatus(`Is allowed parent: ${isAllowed}`);
        return isAllowed;
      } catch (e) {
        updateStatus(`Could not access parent origin: ${e.message}`);
        return false;
      }
    }

    // Message handler
    window.addEventListener('message', async (event) => {
      updateStatus(`Received message from: ${event.origin}`);
      
      if (event.origin !== ALLOWED_PARENT_ORIGIN && event.origin !== OWN_ORIGIN) {
        updateStatus(`Unauthorized origin: ${event.origin}`);
        return;
      }

      if (event.source !== window.parent && event.source !== window) {
        updateStatus('Unauthorized source');
        return;
      }

      updateStatus(`Processing message: ${JSON.stringify(event.data)}`);
      if (event.data.type === 'GET_SECRET') {
        try {
          const secret = await getSecret();
          updateStatus(`Sending secret back: ${secret}`);
          window.parent.postMessage({
            type: 'SECRET_VALUE',
            secret: secret
          }, ALLOWED_PARENT_ORIGIN);
        } catch (error) {
          updateStatus(`Error handling message: ${error.message}`);
          window.parent.postMessage({
            type: 'ERROR',
            error: error.message
          }, ALLOWED_PARENT_ORIGIN);
        }
      }
    });

    // Handle storage access button click
    document.getElementById('requestAccessBtn')?.addEventListener('click', async () => {
      try {
        await document.requestStorageAccess();
        updateStatus('Storage access granted');
        // Test localStorage after getting access
        if (testLocalStorage()) {
          updateStatus('localStorage is now accessible');
        } else {
          updateStatus('localStorage is still not accessible');
        }
        document.getElementById('storageAccessPrompt').classList.add('hidden');
        initialize();
      } catch (error) {
        updateStatus(`Failed to get storage access: ${error.message}`);
        window.parent.postMessage({
          type: 'ERROR',
          error: 'Failed to get storage access'
        }, ALLOWED_PARENT_ORIGIN);
      }
    });

    // Initialize
    async function initialize() {
      if (checkParentOrigin()) {
        // Test localStorage on initialization
        if (testLocalStorage()) {
          updateStatus('Initial localStorage test: accessible');
        } else {
          updateStatus('Initial localStorage test: not accessible');
        }
        const hasAccess = await requestStorageAccess();
        if (hasAccess) {
          updateStatus('Sending READY signal to parent');
          window.parent.postMessage({ type: 'READY' }, ALLOWED_PARENT_ORIGIN);
        }
      } else {
        updateStatus('Not embedded in allowed parent');
        document.body.innerHTML = '<h1>Access Denied</h1><p>This page can only be accessed from the authorized application.</p>';
      }
    }

    // Start initialization
    initialize();
  </script>
</body>
</html> 